<!DOCTYPE HTML>
<html lang="ja">
    <head>
      <meta charset="UTF-8">
      <title>Remaining Time</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <link rel="icon" href="./remainingtime_favicon.png">
      <meta name="twitter:card" content="summary">
      <meta name="twitter:title" content="Remaining Time">
      <meta name="twitter:description" content="è¬›ç¾©ã®æ®‹ã‚Šæ™‚é–“è¡¨ç¤ºã•ã›ã‚‹ãƒšãƒ¼ã‚¸ä½œã£ãŸ PiPã«ã‚‚å¯¾å¿œã—ã¦ã‚‹ã‹ã‚‚(ç’°å¢ƒæ¬¡ç¬¬)">
      <meta name="twitter:image:src" content="./Twitter_card.jpg">
      <meta name="twitter:domain" content="github.io">
      <!-- Chivo Mono ãƒ•ã‚©ãƒ³ãƒˆ -->
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Chivo+Mono:ital,wght@0,100..900;1,100..900&family=Edu+VIC+WA+NT+Beginner:wght@400;700&family=Fjalla+One&family=Share+Tech+Mono&display=swap" rel="stylesheet">
      <!-- Sawarabi Gothic ãƒ•ã‚©ãƒ³ãƒˆ -->
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Sawarabi+Gothic&display=swap" rel="stylesheet">
      <!-- Ysabeau Infant ãƒ•ã‚©ãƒ³ãƒˆ -->
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Ysabeau+Infant:ital,wght@0,1..1000;1,1..1000&display=swap" rel="stylesheet">
      <style>
        ::selection { 
          background-color: #4a87dd; color: #fff58c; 
          }

        body {
          background-color: #000;
          width: 100%;
          height: 100%;
          margin: 0;
          padding: 0;
          }

        button {
          color: #000;
          letter-spacing: 2px;
          font-size: calc(0.8vw + 0.8rem);
          font-weight: bold;
          width: 100%;
          padding: 0.4em;
          position: relative;
          display: block;
          transition: 0.2s;
          border: none;
          background: transparent;
          }

        button::before {
          content: "";
          position: absolute;
          width: 100%;
          height: 100%;
          top: 0;
          left: 0;
          border: 3px solid #9aa9b3;
          border-radius: 35px;
          box-sizing: border-box;
          transform: scale(0);
          opacity: 0;
          transition: transform ease-out 0.3s, opacity 0.5s;
          }

        button:hover {
          color: #9aa9b3;
          }

        button:hover::before {
          transform: scale(1);
          opacity: 1;
          }

        #pip-button {
          background: #000;
          width: 88%;
          margin: 5vh auto;
          cursor: pointer;
          outline: none;
          -webkit-tap-highlight-color: transparent;
          }

        #day, #countdown {
          text-align: center;
          font-family: "Chivo Mono", "Sawarabi Gothic", monospace;
          }

        #day {
          font-size: calc(0.1vw + 1.1rem);
          font-weight: 400;
          letter-spacing: -0.055em;
          }

        #countdown {
          font-size: calc(3.3vw + 1rem);
          font-weight: 800; 
          letter-spacing: 0.06em;
          }

        #box, #pipactive {
          color: #dedede;
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);  
          width: 100%;
          line-height: 1.3;
          cursor: cell;
          }

        #pipactive {
          color: #dedede;
          font-size: calc(1.3vw + 0.5rem);
          font-weight: 600; 
          font-family: "Ysabeau Infant", monospace;   
          letter-spacing: -0.03em;
          text-align: center;
          }
      </style>
    </head>
  <body>

      <button id="pip-button">PiP Open</button>
    
      <div id="box">
        <div id="day"></div>
        <div id="countdown"></div> 
      </div>
      <div id="pipactive"></div>

      <script type="text/javascript">
        // #region CurrentTime 
        const day = document.getElementById("day");
          
          setInterval(function() {
            const date = new Date()
            const A =
                          date.getFullYear() + "-" +
                  ("0" + (date.getMonth() + 1)).slice(-2) + "-" +
                  ("0" +  date.getDate()).slice(-2) + " "               // è¥¿æš¦,æœˆ,æ—¥ ä¸€æ¡ã®æ™‚ã«0åŸ‹ã‚
                  
            const B =
                  (date.getDay());
            const C = 
                  ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"][B]; //ã€€æ›œæ—¥ã‚’å¯¾å¿œã•ã›ã‚‹

            const D =  " " +
                  ("0" +  date.getHours()).slice(-2) + ":" +
                  ("0" +  date.getMinutes()).slice(-2) + ":" +
                  ("0" +  date.getSeconds()).slice(-2)                  //ã€€æ™‚,åˆ†,ç§’ ä¸€æ¡ã®æ™‚ã«0åŸ‹ã‚
              
              day.textContent = A + C + D;
          }, 0);
          // #endregion

          // #region CountdownTimer
                // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ™‚é–“ã®ãƒªã‚¹ãƒˆï¼ˆæ™‚:åˆ†:ç§’ï¼‰
                const targetTimes = ["09:00:01", "10:30:01", "10:40:01", "12:10:01", "13:10:01", "14:40:01", "14:50:01", "16:20:01", "16:30:01", "18:00:01", "24:00:00"];
                // ãã‚Œãã‚Œã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ™‚é–“ã«å¯¾å¿œã™ã‚‹æ–‡
                const messages = ["1é™é–‹å§‹", "1é™çµ‚äº†", "2é™é–‹å§‹", "2é™çµ‚äº†", "3é™é–‹å§‹", "3é™çµ‚äº†", "4é™é–‹å§‹", "4é™çµ‚äº†", "5é™é–‹å§‹", "5é™çµ‚äº†", "ä»Šæ—¥ã‚‚1æ—¥ãŠç–²ã‚Œæ§˜ã§ã—ãŸ"];

                // åˆæœŸåŒ–: æœ€åˆã®ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚’é–‹å§‹
                startCountdown(0);

                function startCountdown(targetTimeIndex) {
                // æ¬¡ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ™‚é–“ã‚’è¨­å®š
                const nextTarget = new Date();
                const [hours, minutes, seconds] = targetTimes[targetTimeIndex].split(":");
                nextTarget.setHours(parseInt(hours, 10), parseInt(minutes, 10), parseInt(seconds, 10), 0); // æŒ‡å®šã•ã‚ŒãŸæ™‚é–“ã«è¨­å®š


                // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã®å‡¦ç†
                const countdown = document.getElementById("countdown");
                const countdownInterval = setInterval(function() {
                const now = new Date();
                const remain = nextTarget.getTime() - now.getTime();

              if (remain < 0) {
                  // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ãŒçµ‚äº†ã—ãŸã¨ãã®å‡¦ç†
                  clearInterval(countdownInterval); // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚’åœæ­¢
                  const newTargetTimeIndex = (targetTimeIndex + 1) % targetTimes.length; // æ¬¡ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ™‚é–“ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨ˆç®—
                  startCountdown(newTargetTimeIndex); // æ¬¡ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ™‚é–“ã§å†å¸°çš„ã«ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚’é–‹å§‹
              } else {
                  let M = Math.floor( remain/ (1000 * 60)); // ãƒŸãƒªç§’ã‹ã‚‰åˆ†ã¸å¤‰æ›
                  let S = Math.floor((remain / 1000) % 60); // ãƒŸãƒªç§’ã‹ã‚‰ç§’ã¸å¤‰æ›
                  M = M < 10 ? "0" + M : M;
                  S = S < 10 ? "0" + S : S; // å€¤ãŒä¸€æ¡ã®æ™‚ã«0åŸ‹ã‚
                  const message = messages[targetTimeIndex]; // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ãŒçµ‚äº†ã—ãŸå ´åˆã«æ¬¡ã®æ–‡ã‚’å–å¾—
            
              // isBetweenTimesé–¢æ•°ã®å®šç¾©
              function isBetweenTimes(now, startTime, endTime) {
                const start = new Date(now.toDateString() + " " + startTime);
                const end = new Date(now.toDateString() + " " + endTime);
                return now >= start && now <= end;
              }
      
              if (isBetweenTimes(now, "18:00:01", "24:00:00")) {
                      // 18:00:01ï½23:59:59ã®å ´åˆ
                  countdown.textContent = message;
                } else {
                      // ãã‚Œä»¥å¤–ã®æ™‚é–“å¸¯ã®å ´åˆ
                  countdown.textContent = message + "ã¾ã§ " + M + ":" + S;
                    }
                }
                }, 0);
              }
          // #endregion

          // #region Picture-in-Picture
              const pipButton = document.getElementById("pip-button");
              if ("documentPictureInPicture" in window) {
          
                let pipWindow = null;
                let Container = null;
          
              // openã®å‡¦ç†
              async function OpenPiP() {
                const player = document.querySelector("#box");
                Container = player.parentNode;
        
                pipWindow = await documentPictureInPicture.requestWindow({
                  width: 350,
                  height: 150,
                  disallowReturnToOpener: true,
                  copyStyleSheets: true
                });
        
                [...document.styleSheets].forEach((styleSheet) => {
                  try {
                    const cssRules = [...styleSheet.cssRules].map((rule) => rule.cssText).join("");
                    const style = document.createElement("style");
        
                    style.textContent = cssRules;
                    pipWindow.document.head.appendChild(style);
                  } catch (e) {
                    const link = document.createElement("link");
        
                    link.rel = "stylesheet";
                    link.type = styleSheet.type;
                    link.media = styleSheet.media;
                    link.href = styleSheet.href;
                    pipWindow.document.head.appendChild(link);
                  }
                });
        
                  pipWindow.document.body.append(player);
        
                  pipButton.textContent = "PiP Close";
                  document.getElementById("pipactive").textContent = "Picture in Picture Mode Is Active Now";
        
                  // PiPã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ä¸Šã®xã‚’æŠ¼ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
                  pipWindow.addEventListener("unload", ClosePiP.bind(pipWindow), {
                    once: true
                  });
                }
        
                  // closeã®å‡¦ç†
                  function ClosePiP() {
                    if (this !== pipWindow) {
                      return;
                    }
                    const player = pipWindow.document.querySelector("#box");
                    Container.append(player);
                    pipWindow.close();
                    pipButton.textContent = "PiP Open";
                    document.getElementById("pipactive").textContent = "";
        
                    pipWindow = null;
                    Container = null;
                }
        
                  // ãƒœã‚¿ãƒ³ã§å®Ÿè¡Œ
                  pipButton.addEventListener("click", () => {
                    if (!pipWindow) {
                      OpenPiP();
                    } else {
                      ClosePiP.bind(pipWindow)();
                    }
                  });
                } else {
                  //PiPéå¯¾å¿œã®å‡¦ç† 
                  pipButton.addEventListener("click", () => {
                    alert("SORRY!!   This device does not support PiPğŸ˜­ğŸ˜­");
                    pipButton.textContent = "PiP is not available";
                  });
                }
            // #endregion  

            // #region FirstLoad
                  const explain = "ç”»é¢ä¸Šéƒ¨ã«Picture in Pictureè¡¨ç¤ºã«ã§ãã‚‹ãƒœã‚¿ãƒ³ãŒéš ã‚Œã¦ã‚‹ã‹ã‚‰æ¢ã—ã¦ã­\n\nä»Šå¾Œã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ãªã„ãªã‚‰ [OK]";

                  window.onload = function() {
                    if (!localStorage.getItem("FirstLoad")) {
                        let check = confirm(explain);

                      if (check) {
                          localStorage.setItem("FirstLoad", true);
                        }
                    }
                  };
            // #endregion            
      </script>
  </body>
</html>
